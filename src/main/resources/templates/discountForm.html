<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create Discount</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" crossorigin="anonymous">
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-CSRF-TOKEN'}"/>
    <style>
        .product-card { background: #fff; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .price-badge { background: linear-gradient(135deg,#11998e 0%,#38ef7d 100%); color: white; padding: .25rem .75rem; border-radius: 12px; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" th:href="@{/admin}">Admin</a>
</nav>
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h3>Create Discount</h3>
        </div>
        <div class="col-md-4 text-right">
            <a th:href="@{/admin/discounts}" class="btn btn-outline-secondary">Back to Discounts</a>
        </div>
    </div>

    <div class="mt-3">
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
    </div>

    <!-- Search area (pre-filled when product passed) -->
    <div class="card mb-3">
        <div class="card-body">
            <form id="searchForm" onsubmit="return false;">
                <div class="form-row align-items-end">
                    <div class="col-md-4">
                        <label>Search Product by ID</label>
                        <input type="number" id="searchProductId" class="form-control" placeholder="Enter product id" th:value="${product.isPresent() ? product.get().id : ''}">
                    </div>
                    <div class="col-md-3">
                        <button id="searchBtn" class="btn btn-primary">Search</button>
                        <button id="clearSearch" class="btn btn-outline-secondary">Clear</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div id="productDetails" class="product-card" style="display:none;">
                <div class="d-flex align-items-center">
                    <img id="productImage" src="" alt="" style="width:80px;height:80px;object-fit:cover;border-radius:6px;margin-right:12px;">
                    <div>
                        <h5 id="productName" class="mb-1"></h5>
                        <div><span class="price-badge">₹ <span id="productPrice"></span></span></div>
                        <div class="text-muted small" id="productCategory"></div>
                    </div>
                </div>
                <div class="mt-2" id="activeDiscountInfo" style="display:none;">
                    <small class="text-warning">This product already has an active discount.</small>
                    <div class="small mt-1" id="activeDiscountDetails"></div>
                </div>
            </div>

            <div id="noProduct" class="product-card text-muted" style="display:none;">
                No product selected or found.
            </div>
        </div>

        <div class="col-md-6">
            <!-- Discount form -->
            <div class="card">
                <div class="card-body">
                    <form th:action="@{/admin/discount/create}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="productId" id="formProductId" th:value="${product.isPresent() ? product.get().id : ''}">
                        <input type="hidden" name="originalPrice" id="formOriginalPrice">

                        <div class="form-group">
                            <label>Product</label>
                            <input type="text" id="formProductName" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label>Discount Price <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" name="discountPrice" id="formDiscountPrice" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label>Discount Percentage</label>
                            <input type="text" id="formDiscountPercentage" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label>End Date <span class="text-danger">*</span></label>
                            <input type="datetime-local" name="endDate" id="formEndDate" class="form-control" required>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-success">Create Discount</button>
                            <a th:href="@{/admin/discounts}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

<script>
$(document).ready(function() {
    function showProduct(product) {
        if (!product) return;
        $('#productDetails').show();
        $('#noProduct').hide();
        $('#productName').text(product.name);
        $('#productPrice').text(product.price);
        $('#productCategory').text(product.category);
        if (product.imageName) {
            $('#productImage').attr('src', '/productImages/' + product.imageName);
        } else {
            $('#productImage').attr('src', '/images/logo.png');
        }
        $('#formProductId').val(product.id);
        $('#formProductName').val(product.name);
        $('#formOriginalPrice').val(product.price);
        $('#formDiscountPrice').val('');
        $('#formDiscountPercentage').val('');
    }

    function showNoProduct() {
        $('#productDetails').hide();
        $('#noProduct').show();
        $('#formProductId').val('');
        $('#formOriginalPrice').val('');
    }

    function populateActiveDiscount(active) {
        if (active) {
            $('#activeDiscountInfo').show();
            $('#activeDiscountDetails').text('Active until: ' + active.endDate + ' — Price: ₹' + active.discountPrice + ' (' + active.discountPercentage + '%)');
        } else {
            $('#activeDiscountInfo').hide();
            $('#activeDiscountDetails').text('');
        }
    }

    function searchProduct(productId) {
        if (!productId) {
            showNoProduct();
            return;
        }
        $.get('/admin/discount/search-product/' + productId, function(resp) {
            if (resp && resp.success) {
                showProduct(resp.product);
                populateActiveDiscount(resp.activeDiscount);
            } else {
                showNoProduct();
            }
        }).fail(function() { showNoProduct(); });
    }

    // Bind search button
    $('#searchBtn').click(function(e) {
        e.preventDefault();
        var id = $('#searchProductId').val();
        searchProduct(id);
    });

    $('#clearSearch').click(function(e) {
        e.preventDefault();
        $('#searchProductId').val('');
        showNoProduct();
    });

    // Auto-calc percentage
    $('#formDiscountPrice').on('input', function() {
        var orig = parseFloat($('#formOriginalPrice').val());
        var disc = parseFloat($(this).val());
        if (orig && disc && disc < orig) {
            var pct = ((orig - disc) / orig * 100).toFixed(1);
            $('#formDiscountPercentage').val(pct);
        } else {
            $('#formDiscountPercentage').val('');
        }
    });

    // Default end date +7 days
    var end = new Date(); end.setDate(end.getDate() + 7); end.setMinutes(end.getMinutes() - end.getTimezoneOffset());
    $('#formEndDate').val(end.toISOString().slice(0,16));

    // If controller passed product, auto-search on load
    /*[[${product.isPresent()}]]*/
    var hasProduct = /*[[${product.isPresent()}]]*/ false;
    if (hasProduct) {
        var pid = /*[[${product.isPresent() ? product.get().id : 0}]]*/ 0;
        $('#searchProductId').val(pid);
        searchProduct(pid);
    } else {
        showNoProduct();
    }
});
</script>
</body>
</html>